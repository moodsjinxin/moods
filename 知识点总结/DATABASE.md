## nosql(非关系型)

![image-20200304111807812](C:\Users\jinxin\AppData\Roaming\Typora\typora-user-images\image-20200304111807812.png)

## mysql

### 数据库引擎

- 作用在表上不同的表可以有不同的引擎

- MYIsam

  - 共有3个文件（结构、数据、索引）
  - 查询索引得到数据地址去数据表中查询数据（需要回表）
  - ![image-20200329095945664](C:\Users\jinxin\AppData\Roaming\Typora\typora-user-images\image-20200329095945664.png)

- Innodb

  - 共2个文件（架构、数据索引）无需回表

  - 叶子结点存放数据，数据以B加树形式存储

  - ![image-20200329100139645](C:\Users\jinxin\AppData\Roaming\Typora\typora-user-images\image-20200329100139645.png)

  - Innodb解决幻读（在可重复读的基础上）

    - MVCC(多版本并发控制)
  
      url ： https://www.jianshu.com/p/133694f3163d
    
      多版本并发控制。InnoDB为每行记录添加了一个版本号（系统版本号），每当修改数据时，版本号加一。
    
      在读取事务开始时，系统会给事务一个当前版本号，事务会读取版本号<=当前版本号的数据，这时就算另一个事务插入一个数据，并立马提交，新插入这条数据的版本号会比读取事务的版本号高，因此读取事务读的数据还是不会变
  
  - 三种锁
    - 记录锁（recored locks） 唯一索引， 为一条记录加锁
    - 间隙所 （GAP LOCK）基于非唯一索引，锁定的是一段区间
    - 临键锁 （next-key lock） 
  
- 事物

  - ACID（原子性、持久性、隔离性、一致性）

    

## 分布式系统理论

### CAP理论

- 内容
  - C  数据一致性
  - A   服务可用性
  - P  网络分区容错性

### 二段提交理论

- 投票阶段
  - 事物协调者向所有参与者咨询能否实现
  - 若某个返回NO 则执行回滚操作
- 提交阶段
  - 协调者收到所有的OK后向参与者发送commit命令
  - 参与者完成commit命令后正式提交事务操作，释放资源。完成事务后向协调者发送ack信息
- 缺点
  - 同步阻塞
  - 脑裂问题

### 三段提交理论

- cancommit阶段
  - 协调者咨询所有参与者能否完成
- precommit阶段
  - 若协调者收到所有的yes，则发出precommit命令进入准备阶段，参与者收到后，执行事务操作，并写入undo和redo事务日志，然后向协调者反馈ack信息
  - 若协调者收到NO则发送abort命令，各参与者中断事务
- docommit阶段
  - 协调者收到所有参与者的响应，则发出docommit命令，所有参与者开始提交事务，释放资源，反馈ack信息
  - 若协调者收到NO反馈或没有反馈，将对所有参与者发生abort命令，参与者利用undo进行回滚
  - 注意点:在第三阶段参与者若没有收到docommit命令，那么超时后它也会提交事务，并反馈自己完成了，因为有其他节点完成了。



### raft

